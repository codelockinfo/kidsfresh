{% comment %}
  Renders a header search inline input. Should be used with 'header.liquid'

  Accepts:
  - input_id: {String} Id for the search input element (required)

  Usage:
  {% render 'header-search', input_id: 'My-Id'%}
{% endcomment %}

<div class="header__search header__search--inline">
  <button
    type="button"
    class="header__icon header__icon--search header__search-toggle link focus-inset"
    aria-label="{{ 'general.search.search' | t }}"
    aria-expanded="false"
  >
    <span class="svg-wrapper">
      {{- 'icon-search.svg' | inline_asset_content -}}
    </span>
  </button>
  
  <div class="header__search-input-wrapper" style="display: none;">
    {%- if settings.predictive_search_enabled -%}
      <predictive-search class="header__search-form" data-loading-text="{{ 'accessibility.loading' | t }}">
    {%- else -%}
      <search-form class="header__search-form">
    {%- endif -%}
    <form action="{{ routes.search_url }}" method="get" role="search" class="search header__search-form">
      <div class="field header__search-field">
        <input
          class="search__input field__input header__search-input"
          id="{{ input_id }}"
          type="search"
          name="q"
          value="{{ search.terms | escape }}"
          placeholder="Search..."
          {%- if settings.predictive_search_enabled -%}
            role="combobox"
            aria-expanded="false"
            aria-owns="predictive-search-results"
            aria-controls="predictive-search-results"
            aria-haspopup="listbox"
            aria-autocomplete="list"
            autocorrect="off"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          {%- endif -%}
        >
        <input type="hidden" name="options[prefix]" value="last">
        <button 
          type="submit" 
          class="header__search-submit" 
          aria-label="{{ 'general.search.search' | t }}"
        >
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.5 12.5L12.5 7.5M12.5 7.5H7.5M12.5 7.5V12.5" stroke="#0F4735" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      {%- if settings.predictive_search_enabled -%}
        <div class="predictive-search predictive-search--header" tabindex="-1" data-predictive-search>
          {%- render 'loading-spinner', class: 'predictive-search__loading-state' -%}
        </div>

        <span class="predictive-search-status visually-hidden" role="status" aria-hidden="true"></span>
      {%- endif -%}
    </form>
    {%- if settings.predictive_search_enabled -%}
      </predictive-search>
    {%- else -%}
      </search-form>
    {%- endif -%}
  </div>
</div>

<style>
  .header__search--inline {
    position: relative;
    display: inline-flex;
    align-items: center;
    margin-left: 10px;
  }

  .header__search--inline .header__search-toggle {
    display: inline-flex;
  }

  .header__search--inline .header__search-input-wrapper.active ~ .header__search-toggle,
  .header__search--inline.active .header__search-toggle {
    display: none;
  }

  .header__search--inline.active .header__search-input-wrapper {
    display: inline-flex !important;
  }

  .header__search-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .header__search-toggle:hover {
    opacity: 0.7;
  }

  .header__search-input-wrapper {
    display: inline-flex;
    align-items: center;
    animation: slideIn 0.3s ease;
    background: transparent;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .header__search-field {
    position: relative;
    margin: 0;
  }

  .header__search-input {
    background-color: #F1EAD9 !important;
    border: 3px solid #679818 !important;
    border-radius: 4px;
    padding: 10px 45px 10px 15px !important;
    font-size: 21px;
    line-height: 33px;
    font-weight: 400;
    color: #0F4735 !important;
    width: 300px;
    font-family: var(--font-family);
    {% comment %} outline: none; {% endcomment %}
    transition: border-color 0.2s ease;
  }

  .header__search-input::placeholder {
    color: #0F4735 !important;
    opacity: 0.7;
  }

  .header__search-input:focus {
    border-color: #679818 !important;
    color: #0F4735 !important;
    outline: none;
  }

  .header__search-submit {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    transition: transform 0.2s ease;
  }

  .header__search-submit:hover {
    transform: translateY(-50%) scale(1.1);
  }

  .header__search-submit:focus {
    outline: 3px solid #679818;
    outline-offset: 2px;
    border-radius: 2px;
  }

  @media screen and (max-width: 768px) {
    .header__search-input {
      width: 250px;
    }
  }

  @media screen and (max-width: 480px) {
    .header__search-input {
      width: 200px;
      padding: 8px 40px 8px 12px !important;
    }
  }
</style>

<script>
(function() {
  const searchWrapper = document.querySelector('.header__search--inline');
  if (!searchWrapper) return;

  const toggleButton = searchWrapper.querySelector('.header__search-toggle');
  const inputWrapper = searchWrapper.querySelector('.header__search-input-wrapper');
  const searchInput = searchWrapper.querySelector('.header__search-input');
  const searchForm = searchWrapper.querySelector('form');
  const submitButton = searchWrapper.querySelector('.header__search-submit');

  if (!toggleButton || !inputWrapper || !searchInput || !searchForm) return;

  let isOpen = false;

  function openSearch() {
    isOpen = true;
    searchWrapper.classList.add('active');
    inputWrapper.style.display = 'inline-flex';
    inputWrapper.classList.add('active');
    toggleButton.setAttribute('aria-expanded', 'true');
    setTimeout(() => {
      searchInput.focus();
    }, 100);
  }

  function closeSearch() {
    isOpen = false;
    searchWrapper.classList.remove('active');
    inputWrapper.style.display = 'none';
    inputWrapper.classList.remove('active');
    toggleButton.setAttribute('aria-expanded', 'false');
    searchInput.value = '';
  }

  toggleButton.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (isOpen) {
      closeSearch();
    } else {
      openSearch();
    }
  });

  // Close when clicking outside
  document.addEventListener('click', function(e) {
    if (isOpen && !searchWrapper.contains(e.target)) {
      closeSearch();
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isOpen) {
      closeSearch();
    }
  });

  // Close search when arrow button is clicked
  if (submitButton) {
    submitButton.addEventListener('click', function(e) {
      // If input has a value, allow form to submit and close search
      if (searchInput.value.trim() !== '') {
        setTimeout(function() {
          if (isOpen) {
            closeSearch();
          }
        }, 100);
      } else {
        // If input is empty, just close without submitting
        e.preventDefault();
        closeSearch();
      }
    });
  }

  // Close search when form is submitted
  searchForm.addEventListener('submit', function(e) {
    // Close the search input after form submission
    setTimeout(function() {
      if (isOpen) {
        closeSearch();
      }
    }, 100);
  });
})();
</script>
